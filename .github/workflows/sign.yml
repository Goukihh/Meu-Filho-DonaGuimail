name: Build and Sign

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm install
      
    - name: Obfuscate code
      run: npm run obfuscate
      
    - name: Build app
      run: npm run build
      
    - name: Create self-signed certificate
      run: |
        $cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=MeuFilhoDonaGuimail" -KeyUsage DigitalSignature -FriendlyName "MeuFilhoDonaGuimail" -CertStoreLocation "Cert:\CurrentUser\My" -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
        $certPath = "cert.pfx"
        $password = ConvertTo-SecureString -String "password" -Force -AsPlainText
        Export-PfxCertificate -Cert $cert -FilePath $certPath -Password $password
        
    - name: Sign executable
      run: |
        signtool sign /f cert.pfx /p password /t http://timestamp.digicert.com "dist/Meu Filho Setup 1.3.2.exe"
        
    - name: Upload signed artifact
      uses: actions/upload-artifact@v4
      with:
        name: signed-app
        path: dist/
